<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guia de Tecidos - Be Diff</title>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: #fff; color: #111827; }
        .bdiff-wrapper { padding: 40px 16px 60px; }
        .bdiff-hero { max-width: 1100px; margin: 0 auto 22px; }
        .bdiff-title { font-size: clamp(24px, 2.6vw, 36px); font-weight: 700; margin: 0 0 8px; }
        .bdiff-subtitle { color: #6B7280; font-size: 15px; }

        .bdiff-quiz {
            max-width: 1100px; margin: 0 auto 40px; padding: 24px;
            border-radius: 16px; background: #F9FAFB; border: 1px solid #E5E7EB;
        }

        .bdiff-quiz-step { display: none; }
        .bdiff-quiz-step.active { display: block; }
        .bdiff-quiz-step h2 { font-size: 18px; font-weight: 600; margin: 0 0 22px; }

        #quiz-mercado { display: grid; grid-template-columns: repeat(7, 1fr); gap: 16px; margin-bottom: 40px; }
        .bdiff-market-card {
            height: 140px; border-radius: 18px; border: 1px solid #E5E7EB; background: #fff;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 12px; cursor: pointer; transition: 0.2s;
        }
        .bdiff-market-card i { font-size: 34px !important; color: #6B7280; }
        .bdiff-market-card span { font-size: 10px; font-weight: 700; text-align: center; line-height: 1.3; padding: 0 8px; }

        /* AJUSTE COR MERCADO SELECIONADO */
        .bdiff-market-card.active { background: #afc6c4; border-color: #8fa6a4; }
        .bdiff-market-card.active i, .bdiff-market-card.active span { color: #111827; }

        /* AJUSTE BOTÃO SUBCATEGORIA - MAIS QUADRADO E PARECIDO COM MERCADO */
        .bdiff-quiz-options { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .bdiff-quiz-options button { 
            border: 1px solid #E5E7EB; background: #fff; padding: 12px 18px; 
            border-radius: 12px; cursor: pointer; font-family: 'Montserrat'; font-size: 12px;
            transition: all 0.2s ease;
        }

        /* AJUSTE SUBCATEGORIA SELECIONADA - COR E NEGRITO */
        .bdiff-quiz-options button.active { 
            background: #afc6c4; 
            border-color: #8fa6a4; 
            font-weight: 800; 
            color: #111827;
        }

        .bdiff-grid { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .bdiff-card { perspective: 1200px; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        
        .bdiff-card-inner {
            position: relative; width: 100%; height: 420px;
            transition: transform 0.6s cubic-bezier(.4,0,.2,1); transform-style: preserve-3d;
        }

        .bdiff-card.is-flipped .bdiff-card-inner { transform: rotateY(180deg); }

        .bdiff-face { position: absolute; inset: 0; backface-visibility: hidden; border-radius: 16px; border: 1px solid #E5E7EB; background: #fff; overflow: hidden; }

        .bdiff-front { display: flex; flex-direction: column; }
        .bdiff-front img { width: 100%; height: 280px; object-fit: cover; display: block; }
        .bdiff-selo-sustentavel {
            position: absolute; top: 12px; left: 12px; background: rgba(255, 255, 255, 0.9);
            color: #2F6B3F; padding: 4px 10px; border-radius: 8px; font-size: 11px;
            font-weight: 600; display: flex; align-items: center; gap: 6px; z-index: 2;
        }
        .bdiff-front .content { padding: 12px; display: flex; flex-direction: column; height: 100%; }
        .bdiff-title-card { font-size: 14px; font-weight: 700; text-transform: uppercase; margin: 0 0 10px; }
        .bdiff-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        .bdiff-tag { display: flex; align-items: center; gap: 4px; font-size: 10px; background: #F3F4F6; padding: 4px 8px; border-radius: 999px; color: #374151; }

        .bdiff-click-info {
            font-size: 9px; text-transform: uppercase; color: #8C7E76; text-align: center;
            margin-top: auto; padding-bottom: 4px; font-weight: 700; letter-spacing: 0.05em;
        }

        .bdiff-back { transform: rotateY(180deg); padding: 16px; display: flex; flex-direction: column; }
        .bdiff-back-scroll { flex: 1; overflow-y: auto; padding-right: 5px; margin-bottom: 10px; }
        .bdiff-back h4 { font-size: 11px; text-transform: uppercase; color: #9CA3AF; margin: 12px 0 6px; }
        .bdiff-back p { font-size: 12px; line-height: 1.5; color: #374151; }
        .bdiff-stars { font-size: 18px; color: #FFD700; margin-bottom: 12px; }
        .bdiff-btn { margin-top: auto; display: block; text-align: center; padding: 12px; border-radius: 999px; font-size: 12px; background: #E6CFC3; color: #3A2A24; font-weight: 800; text-decoration: none; }

        @media(max-width:1024px){ .bdiff-grid { grid-template-columns: repeat(3, 1fr); } #quiz-mercado{grid-template-columns:repeat(4,1fr);} }
        @media(max-width:768px){ .bdiff-grid { grid-template-columns: repeat(2, 1fr); } }
        @media(max-width:480px){ .bdiff-grid { grid-template-columns: 1fr; } #quiz-mercado{grid-template-columns:repeat(2,1fr);} }
    </style>
</head>
<body>

<div class="bdiff-wrapper">
    <div class="bdiff-hero">
        <h1 class="bdiff-title">Escolha o tecido ideal para o seu projeto</h1>
        <p class="bdiff-subtitle">Clique no tecido para ver detalhes técnicos.</p>
    </div>

    <div class="bdiff-quiz">
        <div class="bdiff-quiz-step active" id="step-mercado">
            <h2>Qual é o seu mercado?</h2>
            <div id="quiz-mercado"></div>
        </div>
        <div class="bdiff-quiz-step" id="step-submercado">
            <h2>Refinar por subcategoria:</h2>
            <div class="bdiff-quiz-options" id="quiz-submercado"></div>
        </div>
        <button id="quiz-reset" style="margin-top:20px; cursor:pointer; padding:8px 16px; border-radius:8px; border:1px solid #ddd; background:#fff;">Limpar seleção</button>
    </div>

    <div class="bdiff-grid" id="bdiff-grid"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const grid = document.getElementById("bdiff-grid");
    const mercadoBox = document.getElementById("quiz-mercado");
    const submercadoBox = document.getElementById("quiz-submercado");
    const stepSub = document.getElementById("step-submercado");
    const resetBtn = document.getElementById("quiz-reset");

    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRXsQ1VZ_E6N5wIU-GRUmh_wohwRI_RzTsk3C_UqCZQiK7vt-2tqxR88wezHHia1V3OcqVVBfz_3A-L/pub?output=csv";

    const MERCADOS_FIXOS = ["Acessórios e Brindes", "Artesanato", "Decoração", "Eventos e Corporativo", "Linha Infantil e Enxoval", "Mercado Pet", "Moda e Vestuário"];
    const MERCADO_ICON = { "acessorios e brindes": "ph-bold ph-handbag", "artesanato": "ph-bold ph-scissors", "decoracao": "ph-bold ph-couch", "eventos e corporativo": "ph-bold ph-buildings", "linha infantil e enxoval": "ph-bold ph-baby", "mercado pet": "ph-bold ph-paw-print", "moda e vestuario": "ph-bold ph-t-shirt" };

    let cards = [];
    let selectedMercadoKey = null;
    let selectedSubKey = null;
    const subIndexByMercado = new Map();

    const norm = str => (str || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
    const splitMulti = str => (str || "").split(/[;,|]/g).map(s => s.trim()).filter(Boolean);

    function buildMercadoCards() {
        mercadoBox.innerHTML = "";
        MERCADOS_FIXOS.forEach(label => {
            const key = norm(label);
            const card = document.createElement("div");
            card.className = "bdiff-market-card";
            card.dataset.key = key;
            card.innerHTML = `<i class="${MERCADO_ICON[key]}"></i><span>${label.toUpperCase()}</span>`;
            card.onclick = (e) => { e.stopPropagation(); onSelectMercado(key); };
            mercadoBox.appendChild(card);
        });
    }

    function buildSubIndexFromSheet(rows) {
        subIndexByMercado.clear();
        rows.forEach(item => {
            const rawPairs = splitMulti(item["Mercado:Submercado"]);
            rawPairs.forEach(pair => {
                const parts = pair.split(" - ").map(s => s.trim());
                if (parts.length < 2) return;
                const mKey = norm(parts[0]);
                const sKey = norm(parts[1]);
                if (!subIndexByMercado.has(mKey)) subIndexByMercado.set(mKey, new Map());
                subIndexByMercado.get(mKey).set(sKey, { subLabel: parts[1] });
            });
        });
    }

    function updateSubActiveState(activeBtn) {
        submercadoBox.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
        activeBtn.classList.add('active');
    }

    function buildSubmercadoButtonsForMercado(mercadoKey) {
        submercadoBox.innerHTML = "";
        const subMap = subIndexByMercado.get(mercadoKey);
        if (!subMap || subMap.size === 0) { stepSub.classList.remove("active"); return; }
        stepSub.classList.add("active");
        
        const btnTodos = document.createElement("button");
        btnTodos.innerText = "Todos";
        btnTodos.classList.add('active'); // Inicia selecionado
        btnTodos.onclick = (e) => { 
            e.stopPropagation(); 
            selectedSubKey = null; 
            updateSubActiveState(btnTodos);
            applyFilters(); 
        };
        submercadoBox.appendChild(btnTodos);

        [...subMap.entries()].sort((a, b) => a[1].subLabel.localeCompare(b[1].subLabel)).forEach(([sKey, obj]) => {
            const btn = document.createElement("button");
            btn.innerText = obj.subLabel;
            btn.onclick = (e) => { 
                e.stopPropagation(); 
                selectedSubKey = sKey; 
                updateSubActiveState(btn);
                applyFilters(); 
            };
            submercadoBox.appendChild(btn);
        });
    }

    function applyFilters() {
        cards.forEach(card => {
            const mercados = card.dataset.mercados.split(",");
            const subs = card.dataset.submercados.split(",");
            const mOK = !selectedMercadoKey || mercados.includes(selectedMercadoKey);
            const sOK = !selectedSubKey || subs.includes(selectedSubKey);
            card.style.display = mOK && sOK ? "" : "none";
            card.classList.remove('is-flipped'); 
        });
    }

    function onSelectMercado(key) {
        selectedMercadoKey = key; selectedSubKey = null;
        mercadoBox.querySelectorAll(".bdiff-market-card").forEach(el => el.classList.toggle("active", el.dataset.key === key));
        buildSubmercadoButtonsForMercado(key); applyFilters();
    }

    Papa.parse(SHEET_URL, {
        download: true, header: true, skipEmptyLines: true,
        complete: ({ data }) => {
            grid.innerHTML = ""; cards = [];
            buildSubIndexFromSheet(data);
            data.forEach(item => {
                if (!item["ID Wbuy"]) return;
                const mercados = splitMulti(item["Mercado"]).map(norm);
                const subs = splitMulti(item["Submercado"]).map(norm);
                const sustentavelVal = norm(item["Sustentável"]);
                const cor = parseInt(item["Poder de Cor"]) || 0;

                const card = document.createElement("div");
                card.className = "bdiff-card";
                card.dataset.mercados = mercados.join(",");
                card.dataset.submercados = subs.join(",");
                
                card.addEventListener('click', function(e) {
                    if (e.target.closest('.bdiff-btn')) return; 
                    const isFlipped = this.classList.contains('is-flipped');
                    cards.forEach(c => c.classList.remove('is-flipped'));
                    if (!isFlipped) this.classList.add('is-flipped');
                });

                card.innerHTML = `
                <div class="bdiff-card-inner">
                    <div class="bdiff-face bdiff-front">
                        ${sustentavelVal === "sim" ? `<div class="bdiff-selo-sustentavel"><i class="ph ph-recycle"></i> Sustentável</div>` : ""}
                        <img src="${item["Foto Tecido"] || ""}" alt="${item["Nome do Tecido"]}">
                        <div class="content">
                            <h3 class="bdiff-title-card">${item["Nome do Tecido"]}</h3>
                            <div class="bdiff-tags">
                                <span class="bdiff-tag"><i class="ph ph-stack"></i>${item["Tipo de Base"]}</span>
                                <span class="bdiff-tag"><i class="ph ph-printer"></i>${item["Processo"]}</span>
                                <span class="bdiff-tag"><i class="ph ph-leaf"></i>${item["Fibras"]}</span>
                            </div>
                            <div class="bdiff-click-info">Clique para mais detalhes</div>
                        </div>
                    </div>
                    <div class="bdiff-face bdiff-back">
                        <div class="bdiff-back-scroll">
                            <h4>Descrição</h4><p>${(item["Descrição"] || "").replace(/\n/g, "<br>")}</p>
                            <h4>Intensidade de cor</h4><div class="bdiff-stars">${"★".repeat(cor)}${"☆".repeat(5 - cor)}</div>
                            <h4>Aplicações</h4><p>${item["Sugestão de Produtos"]}</p>
                            <div style="font-size:11px; margin-top:8px;">
                                <p><strong>Prós:</strong> ${item["Prós (Técnico)"]}</p>
                                <p><strong>Contras:</strong> ${item["Contras (Técnico)"]}</p>
                            </div>
                        </div>
                        <a href="${item["ID Wbuy"]}" target="_blank" class="bdiff-btn">COMPRAR AGORA</a>
                    </div>
                </div>`;
                grid.appendChild(card); cards.push(card);
            });
            buildMercadoCards();
        }
    });
    resetBtn.onclick = () => { selectedMercadoKey = null; selectedSubKey = null; stepSub.classList.remove("active"); buildMercadoCards(); applyFilters(); };
});
</script>

</body>
</html>
